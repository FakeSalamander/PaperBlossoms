# Data

Last updated: 2020-09-14 (post-PoW release)

The application database is [paperblossoms.db](paperblossoms.db), a SQLite database. However, in order to make data entry easier, more reliable and more maintainable, data is never entered directly into `paperblossoms.db`. Instead, data is entered in [JSON](json/) files, which are then flattened and normalized into `paperblossoms.db` with the Python script [json_to_db.py](scripts/json_to_db.py). Below, I describe the structure of the application database and the data entry system I devised to minimize tedium and maximize reliability.

If you want to help with data entry, you may want to skip to the section [Data entry tasks](#data-entry-tasks). When you get confused, you can refer to the [Data entry system](#data-entry-system) for a more thorough explanation of how the system works.

Directory contents:

- [json/](json/): See [JSON data](#json-data)
- [json_schema/](json_schema/): See [JSON schemas](#json-schemas)
- [scripts/](scripts/): See [Scripts](#scripts)
- [paperblossoms.db](paperblossoms.db): See [Application database](#application-databes-paperblossoms-db)
- [vscode_workspace_settings.json](vscode_workspace_settings.json): See [JSON schemas](#json-schemas)

## Application database `paperblossoms.db`

There are three sources of data which you will find in your own copy of the application database:

- Base data (`base_*` tables): The data entered from the books, included as part of the application release. This is the data that is entered in JSON and then imported into `paperblossoms.db`.
- Custom user data (`user_*` tables, `*desc*` columns): Data that the user enters in their own local copy of Paperblossoms. Custom additions to the game, like new schools or new advantages, are stored in `user_` tables. `*desc*` columns exist for storing descriptions (e.g., for each technique). The Paperblossoms team does not distribute this data to avoid infringing on FFG's copyright on the L5R books, but users who own the books may choose to enter verbatim text if they so wish, and store it with the application for display on, e.g., their character sheets. 
- Translations (`i18n` table, `*_tr` columns): Paperblossoms is lucky enough to benefit from generous volunteer translators. The `i18n` table is populated with a table of translations from the [i18n](i18n/) directory at application launch. For more detail on how translations are populated and fetched, see [Translations](#translations) below.

The data entry system is focused on entering base data, but support for custom user data and translations are programmatically generated by `json_to_db.py`: `base_*` and `user_*` tables have identical fields, and are joined together in views without a prefix. The application references these views, so base data and user data are combined and treated equivalently. The views also include joins to the `i18n` table, so the application can fetch translated strings if they exist.

## Data entry system

### JSON data

Each JSON file represents an array of objects, representing high-level concepts in the game, such as clans, schools and weapons. Here's one of the simplest examples, [rings.json](json/rings.json):

```
[
    {
        "name": "Air",
        "outstanding_quality": "Grace, eloquence or empathy"
    },
    {
        "name": "Earth",
        "outstanding_quality": "Thoroughness, patience or calm"
    },
    {
        "name": "Fire",
        "outstanding_quality": "Creativity, passion or drive"
    },
    {
        "name": "Water",
        "outstanding_quality": "Adaptability, friendliness or awareness"
    },
    {
        "name": "Void",
        "outstanding_quality": "Self-awareness, insight or mysticism"
    }
]
```

For one of the most complicated examples, check out [schools.json](json/schools.json).

### JSON schemas

Every [JSON](json/) file pairs with a [JSON schema](json_schema/) of the same name. The JSON schemas serve multiple purposes:

- They're leveraged to programmatically generate ['default snippets'](https://code.visualstudio.com/docs/languages/json#_define-snippets-in-json-schemas) for VS Code (see [add_default_snippets_to_schema.py](scripts/add_default_snippets_to_schema.py)). These snippets generate autocompletion proposals which include keys and values, and substantially reduce typing (and therefore errors) during data entry.
- They're used to generate autocompletion proposals for and validate strings with the [`enum` keyword](https://json-schema.org/understanding-json-schema/reference/generic.html#id4), substantially increasing the consistency of how string data is capitalized, punctuated and spelled.
- They're used to validate the entire JSON file (see [validate_json.py](scripts/validate_json.py)).
- They document the intended meaning of each field.

Here's a relatively simple example which features default snippets and `enum`s, [bonds.schema.json](json_schema/bonds.schema.json):

```
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "Bonds",
    "description": "List of bond types",
    "type": "array",
    "items": {
        "description": "Type of bond",
        "type": "object",
        "properties": {
            "name": {
                "description": "Name of bond type",
                "type": "string"
            },
            "ability": {
                "description": "Bond ability",
                "type": "string"
            },
            "reference": {
                "description": "Page reference for clan",
                "type": "object",
                "properties": {
                    "book": {
                        "description": "Book in which reference can be found",
                        "type": "string",
                        "enum": [
                            "Core",
                            "EE",
                            "SL",
                            "Mantis",
                            "GMK",
                            "CoS",
                            "PoW"
                        ]
                    },
                    "page": {
                        "description": "Page on which reference can be found",
                        "type": "integer"
                    }
                },
                "required": [
                    "book",
                    "page"
                ],
                "defaultSnippets": [
                    {
                        "label": "New Page reference for clan",
                        "body": {
                            "book": "$1",
                            "page": "^$2"
                        }
                    }
                ]
            }
        },
        "required": [
            "name",
            "ability",
            "reference"
        ],
        "defaultSnippets": [
            {
                "label": "New Type of bond",
                "body": {
                    "name": "$1",
                    "ability": "$2",
                    "reference": "^$3"
                }
            }
        ]
    }
}
```

Again, the most complicated example is [schools.schema.json](json_schema/schools.schema.json).

### Scripts

A handful of [helper scripts](scripts/) automate common tasks. These tasks fall into two categories: tasks which are part of the data entry workflow and tasks which update the data entry system. 

The general data entry workflow is as follows:

1. Modify JSON file(s): manual
2. Validate JSON file(s): [validate_json.py](scripts/validate_json.py)
3. Export data from JSON files to `paperblossoms.db`: [json_to_db.py](scripts/json_to_db.py)

`validate_json.py` loops through schemas found in the `json_schema/` directory and validates the JSON of the same name in the `json/` directory. It will raise an informative error if a JSON fails validation. This script takes no arguments, and outputs the schema name as it loops.

```
$ python3 PaperBlossoms/data/scripts/validate_json.py 
Validated qualities.json
Validated armor.json
Validated techniques.json
Validated bonds.json
Validated personal_effects.json
Validated titles.json
Validated samurai_heritage.json
Validated schools.json
Validated item_patterns.json
Validated upbringings.json
Validated rings.json
Validated skill_groups.json
Validated regions.json
Validated clans.json
Validated weapons.json
Validated advantages_disadvantages.json
```

`json_to_db.py` is the workhorse script for converting JSON data into SQLite data. It constructs the entire SQLite database, including base data, custom data, and translations. It loads data from each JSON and writes that data to SQLite tables in a flattened and normalized way. It takes no arguments and doesn't write to stdout.

```
$ python3 PaperBlossoms/data/scripts/json_to_db.py
```

Other scripts modify the data entry system via the JSON schemas.

`add_default_snippets_to_schema.py` adds or overwrites default snippets to a specified JSON schema based on the schema. This script is intended to be used after a new schema is written or an existing schema is updated. Rather than manually adding or updating the default snippets, use this script to automatically generate those snippets. They can be modified afterwards in order to set default values, remove unwanted fields, etc. This script takes one argument, the JSON schema file, and will add default snippets for all objects in the JSON schema, no matter the level of nesting.

```
$ python3 PaperBlossoms/data/scripts/add_default_snippets_to_schema.py PaperBlossoms/data/json_schema/bonds.schema.json
```

`add_enums.py` adds or overwrites `enum` lists in JSON schemas based on entered data (primarily JSON). For example, to generate a valid list of skills and techniques for school curriculum advancements, this script will load `skills.json` and `techniques.json`, extract the names of all skills and techniques, and write those names as the `enum` list for `advance` in `curriculum` within `schools.json`. This script is intended to be used when an `enum` list needs to be refreshed (new techniques, new books, etc). It takes the following arguments:

```
$ python3 PaperBlossoms/data/scripts/add_enums.py --option books
Writing books ...
... to clans
... to advantages/disadvantages
... to armor
... to personal effects
... to weapons
... to techniques
... to schools
... to titles
... to bonds
... to item patterns
$ python3 PaperBlossoms/data/scripts/add_enums.py -h
usage: add_enums.py [-h] [--option [{rings,clans,skills,techniques,qualities,equipment,advantages,books,resistance,currency} [{rings,clans,skills,techniques,qualities,equipment,advantages,books,resistance,currency} ...]]]

Utility to add enums to json schema

optional arguments:
  -h, --help            show this help message and exit
  --option [{rings,clans,skills,techniques,qualities,equipment,advantages,books,resistance,currency} [{rings,clans,skills,techniques,qualities,equipment,advantages,books,resistance,currency} ...]]
                        Which enums you want to write to json schemas (defaults to all with no arguments specified)
```

## Data entry tasks

---

### How do I add a new [school/clan/instantiation of existing concept]?

Simply add an object to an existing array. The details of the format are determined by the JSON schema associated with the JSON file. JSON schemas are described in a later section. For example, if you wanted to add a new 

### How do I add a new concept?

